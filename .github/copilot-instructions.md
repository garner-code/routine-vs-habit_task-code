# Copilot Instructions: Visual Foraging Task

## Project Overview
This is a **MATLAB-based behavioral task** for visual foraging experiments using Psychtoolbox. It implements a multi-stage visual search task where participants find targets behind doors with learned probabilistic contexts.

**Key characteristics:**
- Two experiment types: Task Switching (TS) vs Learning Transfer (LT)
- Three stages per participant: Learning (stage 1) → Training (stage 2) → Test (stage 3)
- Counterbalanced context/door assignments across 128+ participants
- BIDS-like data output structure (TSV behavioral data + JSON metadata)
- Eye-tracker integration (SMI Red) for gaze-contingent door selection

## Architecture: Three Core Components

### 1. **Counterbalancing System** (`sub_infos.mat`)
The file `generate_sub_info_mat.m` creates `sub_infos.mat` (128×24 matrix) that governs all task parameters per participant:
- **Cols 3-6**: Context A door indices (which of 16 doors get p=0.25)
- **Cols 7-10**: Context B door indices  
- **Cols 15-18**: Hybrid context (half A doors, half B doors) for transfer test
- **Cols 19-22**: Color assignments for context visualization
- **Col 23**: Transfer type (1=complete, 2=hybrid)
- **Col 24**: Transfer order (1=complete-first, 2=hybrid-first)

**Always load this before generating trial structure:** `load('sub_infos.mat'); sub_config = sub_infos(sub.num, :)`

### 2. **Trial Structure Generation Pipeline**
Three stage-specific functions create trial matrices [n_trials × 5] with columns:
1. Trial number
2. Context (1 or 2, or house number for learning)
3. Target door location
4. Target probability  
5. Target identity (1-100)

| Stage | Function | Key Parameter | Notes |
|-------|----------|---|---|
| **Learning (1)** | `generate_trial_structure_learn.m` | `house` (1, 2, or 9) | Single context per house or mixed |
| **Training (2)** | `generate_trial_structure_train.m` | `switch_prob` (.05 or .3) | Context switches on rewarded trials |
| **Test (3)** | `generate_trial_structure_tstest.m` (TS) or `generate_trial_structure_lttest.m` (LT) | Experiment ID | 50% context switches (TS) or transfer conditions (LT) |

All functions require: `door_probs` (loaded from `.mat` files like `probs_cert_world_v2.mat`)

### 3. **Interactive Task Loop** (`run_iforage_task.m`)
Main workflow:
1. **Input phase**: Collect participant/stage/experiment info
2. **Setup**: Create subject directory structure, load counterbalancing, generate trials
3. **Execution**: Loop through trials calling `query_door_select.m` → `query_open_door.m`
4. **Output**: Write trials TSV + metadata JSON

**Critical files in loop:**
- `query_door_select.m`: Wait for mouse click in door region, return door index
- `query_open_door.m`: Check if selected door matches target, record hit/miss
- `draw_doors.m`, `draw_background.m`: Psychtoolbox screen rendering

## Data I/O Conventions

### **Input Files** (All .mat)
- `sub_infos.mat`: [128×24] counterbalancing matrix
- `probs_cert_world_v2.mat`: Probability distributions for door locations
- `learn_blocks.mat`: Block structure for certain conditions
- `col_assigns.mat`: Possibly color assignments (see `generate_sub_info_mat.m`)

### **Output Structure**
```
exp_ts/  or  exp_lt/
├── sub-XXX/
│   ├── ses-learn/
│   │   └── beh/
│   │       ├── sub-XXX_ses-learn_house-1_task-mforage_trls.tsv
│   │       └── sub-XXX-ses-learn_house-1_task-mforage_sess-params.mat
│   ├── ses-train/
│   └── ses-test/
```

**TSV format** (from `write_trials_and_params_file.m`):
```
sub	sess	t	cond	loc	prob	tgt
1	1	1	1	5	1	42
```
Columns: subject, session(stage), trial#, condition(context), location, probability, target_id

### **Metadata JSON** (BIDS-style)
- Generated by `generate_task_metadata.m`
- Contains hardware specs (monitor 530×300mm, viewing distance 570mm, 100Hz refresh)
- Eye-tracker calibration parameters (SMI Red at -2mm vertical, 60mm horizontal offset)

## Critical Conventions & Dependencies

### **Stage/Experiment Encoding**
- **Stages**: 1=learn, 2=train, 3=test (also '4'=learn-check for instructions only)
- **Experiments**: 1=task-switching (ts), 2=learning-transfer (lt)
- **Houses** (learning only): 1=house1 single-context, 2=house2 single-context, 9=mixed

### **Random Seeding**
Always replicate participant randomness: `r_num = [num2str(sub.num) num2str(sub.stage)]; rand('state', str2double(r_num))`

### **Probability Distribution System**
- Door probabilities stored as row vectors in files like `probs_cert_world_v2.mat`
- Typical configuration: 4 doors with p=0.25 each (12 doors with p=0)
- Function `get_locs_given_probs_v2.m` converts probability distribution to trial-by-trial door sequence

### **Eye-Tracker Integration** (SMI Red)
- Functions in `unused-functions/` folder (deprecated but reference implementation)
- Modern path uses mouse input via `query_door_select.m` with `GetMouse` (Psychtoolbox)
- Door selection radius `r` is hardcoded parameter (check in main loop)

## Common Edit Patterns

1. **Changing trial counts**: Edit `run_iforage_task.m` lines ~80-130 (ntrials assignments per stage)
2. **Adding logging**: Extend TSV columns in `write_trials_and_params_file.m` fprintf statements
3. **Adjusting visual parameters**: Door/edge colors and rectangles in `query_door_select.m`, `define_door_rects_v2.m`
4. **Modifying context switching**: Alter `switch_prob` parameter in `generate_trial_structure_train.m`

## Validation Checklist
- Verify `sub_infos.mat` before running (run `run_counterbalancing_check.m`)
- Ensure door indices 1-16 map to display coordinates via `define_door_rects_v2.m`
- Check that ntrials is divisible by number of contexts (e.g., 4 for 2 contexts with 2 switch probabilities)
- Confirm screen dimensions match monitor settings (530×300mm) before testing

## Key File Organization
- **Top-level**: Entry points (`run_*.m`), counterbalancing setup, metadata generation
- **`unused-functions/`**: Deprecated eye-tracker and alternate implementations (reference only)
- **`JSONio/`**: JSON read/write utilities for metadata
- **`prob_definitions/`**: Probability distributions and visualizations
- **`sub-999/`**: Example subject folder structure (test/template)
